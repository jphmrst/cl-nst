\section{The runtime system}
The runtime system provides several operations for scheduling and
running tests, and debugging failing and erring tests.  The operations
are accessible from
the~\texttt{nst-cmd}\index{nst-cmd@\texttt{nst-cmd}} macro.  Under
Allegro, the top-level alias \texttt{:nst}\index{nst@\texttt{:nst}}
provides a shorthand to this function; for the sake of brevity we use
this shorthand below.

The \texttt{:help} command gives a complete inventory of runtime
system commands:\index{help@\texttt{:help}}
\begin{verbatim}
 :nst :help
 (nst-cmd :help)
\end{verbatim}

There are a numnber of commands for running tests, but most of the
time only one will be needed:
\begin{itemize}
\item\texttt{:nst :run {\itshape name}}\index{run@\texttt{:run}}
  \par Run all tests in the named package, or in the named group, or
  run the named test.  It is not necessary to prefix the name with a
  package prefix.
\end{itemize}
When a name corresponds to several different types of entities, or to
different entities in different packages, it is necessary to use a
more specific instruction:
\begin{itemize}
\item\texttt{:nst :run-package {\itshape name} {\itshape name} \ldots\ {\itshape name}}\index{run-package@\texttt{:run-package}}
  \par Run all tests defined in groups in the named packages.  If no
  packages are given, then the current value of \texttt{*package*} is
  used.
\item\texttt{:nst :run-group {\itshape group-name}}\index{run-group@\texttt{:run-group}}
  \par Run all tests in the given group.  Where appropriate, the name
  should be package-prefixed.
\item\texttt{:nst :run-test {\itshape group-name} {\itshape test-name}}\index{run-test@\texttt{:run-test}}
  \par Run the named test.  Where appropriate, the names should be
  package-prefixed.
\end{itemize}
One further command for running a test is useful when writing and
debugging the tests themselves:
\begin{itemize}
\item\texttt{:nst :apply {\itshape criterion} {\itshape form} {\itshape form} $\cdots$ {\itshape form}}\index{apply@\texttt{:apply}}
  \par Test the {\itshape form}s against the given {\itshape
    criterion}.  The test proceeds just as if the criterion and forms
  were given in a \texttt{def-test} and that test run.  Of course, any
  fixtures expected in one of the {\itshape form}s would not
  necessarily be present in the runtime environment; fixtures may need
  to be \texttt{open}ed.
\end{itemize}

There are two commands for (re)printing the results of tests:
\begin{itemize}
\item\texttt{:nst :report}\index{report@\texttt{:report}}
\\ \texttt{:nst :report {\itshape package-name}}
\\ \texttt{:nst :report {\itshape group-name}}
\\ \texttt{:nst :report {\itshape group-name} {\itshape test-name}}
\item\texttt{:nst :detail}\index{detail@\texttt{:detail}}
\\ \texttt{:nst :detail {\itshape package-name}}
\\ \texttt{:nst :detail {\itshape group-name}}
\\ \texttt{:nst :detail {\itshape group-name} {\itshape test-name}}
\end{itemize}
The \texttt{:report} command summarizes successes, failures and
errors; the \texttt{:detail} command gives more detailed information
about individual tests.

The \texttt{:undef} command cancels the definition of a group or test:
\begin{quotation}\noindent
 \texttt{:nst :undef {\itshape group-name}}
\\ \texttt{:nst :undef {\itshape group-name} {\itshape test-name}}
\end{quotation}
Currently, NST does require that the symbols passed to \texttt{:undef}
be correctly package-qualified.

The \texttt{:clear} command erases NST's internal record of test
results.

The \texttt{:set} and \texttt{:unset} commands adjust NST's
configuration.
\begin{itemize}
\item\texttt{:nst :set {\itshape property} {\itshape value}}\index{set@\texttt{:set}}
\item\texttt{:nst :unset {\itshape property} {\itshape value}}\index{unset@\texttt{:unset}}
\end{itemize}
There are currently three properties which can be manipulated by
\texttt{:set}\,:
\begin{itemize}
\item\texttt{:verbose}\index{verbose@\texttt{:verbose}}~~ Controls the
  level of output at various points of NST.  Valid settings are:
  \begin{tightlist}
  \item\texttt{:silent} (aka \texttt{nil})
  \item\texttt{:quiet} (aka \texttt{:default})
  \item\texttt{:verbose} (aka \texttt{t})
  \item\texttt{:vverbose}
  \end{tightlist}

  The \texttt{:report} and \texttt{:detail} commands operate by
  setting minimum levels of verbosity.

\item\texttt{:debug-on-error}\index{debug-on-error@\texttt{:debug-on-error}}~~
  When this property has a non-nil value, NST will exit into the
  debugger when it catches an error.

\item\texttt{:debug-on-fail}\index{debug-on-fail@\texttt{:debug-on-fail}}~~
  When this property has a non-nil value, NST will exit into the
  debugger whenever a test fails.  This test is useful for inspecting
  the environment in which a test is run.  Note that both
  \texttt{:debug-on-error} and \texttt{:debug-on-fail} apply in the
  case of an error; if the latter is set but the former is not, then
  the debugger will be entered after an erring test completes.

  The \texttt{:debug} command is a short-cut for setting this
  two properties.\index{debug@\texttt{:debug}}

\item\texttt{:backtraces}\index{backtraces@\texttt{:backtraces}}~~
  When this property has a non-nil value, NST attempts to capture
  attempts the Lisp backtrace when a test throws an error.  This
  property is only available on platform which allow programmatic
  examination of backtraces, which is not standardized in Common Lisp;
  currently we have implemented this feature on Allegro only.

  This property has a complicated default setting.  Firstly, if the
  symbol \texttt{'common-lisp-user::*nst-generate-backtraces*} is
  bound when NST loads, NST will use its value as the initial value
  for this property.  Otherwise by default, on MacOS systems the
  property initializes to \texttt{nil} because of a known error on
  that system, but this setting can be overriden by the property
  \texttt{:nst-unsafe-allegro-backtraces}.  Finally, if none of these
  issues apply, the initial value is \texttt t.
\end{itemize}

Fixtures\index{fixtures!debugging} can be \emph{opened} into the
interactive namespace for debugging with the
\texttt{:nst~:open}\index{open@\texttt{:open}} command:\index{open@\texttt{:open}}%
\\ Syntax: \texttt{:nst :open FIXTURE-NAME FIXTURE-NAME ... FIXTURE-NAME}
\\ Example:
\begin{verbatim}
  CL-USER(75): (nst:def-fixtures small-fixture ()
                  (fix-var1 3)
                  (fix-var2 'asdfg))
  NIL
  CL-USER(76): (boundp 'fix-var1)
  NIL
  CL-USER(77): :nst :open small-fixture
  Opened fixture SMALL-FIXTURE.
  CL-USER(78): fix-var1
  3
  CL-USER(79): 
\end{verbatim}
Fixtures can be opened into a different package than where they were
first defined, but these bindings are in addition to the bindings in
the original package, and are made by a symbol import to the
additional package.

Calling \texttt{:nst} or \texttt{(nst-cmd}) without a command argument
repeats the last test-executing command.

%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "manual"
%%% End: 
