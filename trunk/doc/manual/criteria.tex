
\section{Defining test criteria}
The criteria used in test forms decide whether, when and how to use
the forms under test and the forms and subcriteria provided to each
test criterion.  Criteria receive their arguments as forms, and may
examine them as forms with or without evaluation, as the particular
criterion requires.  NST provides three mechanisms for defining new
criteria.
\begin{itemize}
\item Defining a criterion by specifying how it should be rewritten to
  another criterion.  This mechanism is both the simplest and the most
  limited in the manipulations it can define.  The
  \texttt{def-criterion-alias} macro provides this mechanism, which we
  discuss in Section~\ref{sec:def-criterion-alias}.
\item Defining a criterion with call-by-value semantics for the values
  under test, specifying how it assesses the results of evaluating the
  forms under test.  The \texttt{def-criterion} macro provides this
  mechanism, which we discuss in Section~\ref{sec:def-criterion}.
\item Defining a criterion receiving the original, unmanipulated forms
  provided as criterion arguments and forms under test.  The
  \texttt{def-criterion-unevaluated} macro provides this mechanism,
  which we discuss in Section~\ref{sec:def-criterion-unevaluated}.
\end{itemize}
The first mechanism is essentially a variation of \texttt{defmacro}.
Under both of the latter two mechanisms, the criteria definition is
made as Lisp code calculating a \emph{test report}.

The functions and macros for defining new criteria are exported from
package \texttt{nst-criteria-api}.

\subsection{Aliases over criteria}
\label{sec:def-criterion-alias}
The simplest mechanism for defining a new criterion involves simply
defining one criterion to rewrite as another using
\texttt{def-criterion-alias}:\index{def-criterion-alias@\texttt{def-criterion-alias}}
%
{\ttfamily\begin{tabbing}
\textrm{Syntax: 
}(de\=f-criterion-alias (name \&rest args)
\\ \> [ documentation ]
\\ \> expansion)
\end{tabbing}}
The body of the expansion should be a Lisp form which, when evaluated,
returns an S-expression quoting the new criterion which the rewrite
should produce.  The \texttt{args} are passed as far Lisp macros: they
are not evaluated and are most typically comma-inserted into a
backquoted result.  For example:
\\ \texttt{(def-criterion-alias (:forms-eq) `(:predicate eq))}
\\ \texttt{(def-criterion-alias (:symbol name) `(:eq ',name))}

\subsection{Reporting forms}
\label{sec:criteria-forms-report}
The other two criteria-defining mechanisms define the expansion of a
criterion into Lisp.  For both of these mechanisms, this Lisp code is
expected to return a test report.  NST provides three functions for
building test reports:
\begin{itemize}
\item
  \input{../gen/make-success-report_function_latex-style}
  \index{make-success-report@\texttt{make-success-report}}
\item
  \input{../gen/make-failure-report_function_latex-style}
  \index{make-failure-report@\texttt{make-failure-report}}
  \index{failure@\texttt{failure}}
\item
  \input{../gen/make-warning-report_function_latex-style}
  \index{make-warning-report@\texttt{make-warning-report}}
  \index{warning@\texttt{warning}}
\end{itemize}

\subsection{Defining criteria over evaluated values}
\label{sec:def-criterion}
\input{../gen/def-criterion_compiler-macro_latex-style}%

\subsection{Processing subcriteria on values}
\label{sec:subcriteria-values}
Since the arguments to the criterion itself (as opposed to the tested
forms) are passed unevaluated as for macro arguments, they can contain
\emph{subcriteria} which can be incorporated into the main criterion's
assessment.%
  \index{check-subcriterion-on-value@\texttt{check-subcriterion-on-value}}

{\ttfamily\begin{tabbing}
\textrm{Syntax: }(check-subcriterion-on-value CRITERION EXPR)
\end{tabbing}}
% The \texttt{continue-check} function converts subcriteria into quoted
% Lisp:
% \begin{verbatim}
%   (continue-check criterion-form values-forms)
% \end{verbatim}
% The \texttt{values-forms} argument should be a quoted Lisp expression
% which, when evaluated, returns a list of values to be assessed by the
% subcriterion.
% 
% In fact, \texttt{def-form-criterion} and \texttt{def-values-criterion}
% expand to method definitions which are used in \texttt{continue-check}.

\subsection{General criteria definitions}
\label{sec:def-criterion-unevaluated}
\index{def-criterion-unevaluated@\texttt{def-criterion-unevaluated}}
{\ttfamily\begin{tabbing}
\textrm{Syntax: }(de\=f-criterion-unevaluated (\=name
\\ \>            \>criterion-args-lambda-list)
\\ \>            \>form-argument)
\\ \> FORM
\\ \> FORM
\\ \> ~$\vdots$
\\ \> FORM)
\end{tabbing}}%
As under \texttt{def-criterion}, the body of these criteria
definitions receive the forms provided as the actual parameters of the
criterion itself, and should return a test result report.  However,
these criteria receive the unevaluated forms under test, deciding when
and whether to evaluate them.
% 
% Examples:
% \begin{verbatim}
% (def-form-criterion (:apply (transform criterion) forms)
%   (continue-check criterion
% 		  `(multiple-value-list (apply #',transform ,forms))))
% 
% (def-form-criterion (:not (subcriterion) exprs-form)
%   (let ((subcheck (gensym)))
%     `(let ((,subcheck ,(continue-check subcriterion exprs-form)))
%        (cond
%         ((check-result-errors ,subcheck)
%          ,subcheck)
%         ((check-result-failures ,subcheck)
%          (check-result :info (check-result-info ,subcheck)))
%         (t
%          (make-failure-report :format "Expected failure from ~s"
%                        :args '(,subcriterion)))))))
% \end{verbatim}

\subsection{Processing subcriteria on the unevaluated form}
\label{sec:subcriteria-form}
{\ttfamily\begin{tabbing}
\textrm{Syntax: }(check-subcriterion-on-form CRITERION FORM)
\end{tabbing}}%
  \index{check-subcriterion-on-form@\texttt{check-subcriterion-on-form}}

\subsection{Older criteria-defining macros}
\label{sec:def-values-criterion}
\label{sec:def-form-criterion}
The \texttt{def-values-criterion} and \texttt{def-form-criterion}
macros are deprecated as of NST 1.3.0, and will be make-emoved-report at some
point.  Code using \texttt{def-values- criterion} should continue to
work as before.  \emph{However, code using \texttt{def-form-
    criterion} in any but the simplest ways is very likely to fail.}
%
In NST 1.3 criteria are translated into method definitions, whereas in
earlier versions criteria guided the macro expansion of tests.
Unfortunately, the nature of \texttt{def-form-criterion} declarations
eludes translation into the new scheme.%
  \index{def-values-criterion@\texttt{def-values-criterion}}%
  \index{def-form-criterion@\texttt{def-form-criterion}}

%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "manual"
%%% TeX-PDF-mode: t
%%% End: 
