
\section{Defining test criteria}
The criteria used in test forms decide whether, when and how to use
the forms under test and the forms and subcriteria provided to each
test criterion.  Criteria receive their arguments as forms, and may
examine them as forms with or without evaluation, as the particular
criterion requires.  NST provides three mechanisms for defining new
criteria.
\begin{itemize}
\item Defining a criterion by specifying how it should be rewritten to
  another criterion.  This mechanism is both the simplest and the most
  limited in the manipulations it can define.  The
  \texttt{def-criterion-alias} macro provides this mechanism, which we
  discuss in Section~\ref{sec:def-criterion-alias}.
\item Defining a criterion with call-by-value semantics for the values
  under test, specifying how it assesses the results of evaluating the
  forms under test.  The \texttt{def-criterion} macro provides this
  mechanism, which we discuss in Section~\ref{sec:def-criterion}.
\item Defining a criterion receiving the original, unmanipulated forms
  provided as criterion arguments and forms under test.  The
  \texttt{def-criterion-unevaluated} macro provides this mechanism,
  which we discuss in Section~\ref{sec:def-criterion-unevaluated}.
\end{itemize}
The first mechanism is essentially a variation of \texttt{defmacro}.
Under both of the latter two mechanisms, the criteria definition is
made as Lisp code calculating a \emph{test report}.

The functions and macros for defining new criteria are exported from
package \texttt{nst-criteria-api}.

\subsection{Aliases over criteria}
\label{sec:def-criterion-alias}
\input{../gen/def-criterion-alias_compiler-macro_nst-item-style}

\subsection{Reporting forms}
\label{sec:criteria-forms-report}
The other two criteria-defining mechanisms define the expansion of a
criterion into Lisp.  For both of these mechanisms, this Lisp code is
expected to return a test report.  NST provides three functions for
building test reports, and three for adding information to a report:
\begin{itemize}
\item
  \input{../gen/make-success-report_function_nst-item-style}
  \index{make-success-report@\texttt{make-success-report}}
\item
  \input{../gen/make-failure-report_function_nst-item-style}
  \index{make-failure-report@\texttt{make-failure-report}}
  \index{failure@\texttt{failure}}
\item
  \input{../gen/make-warning-report_function_nst-item-style}
  \index{make-warning-report@\texttt{make-warning-report}}
  \index{warning@\texttt{warning}}
\item
  \input{../gen/make-error-report_function_nst-item-style}
  \index{make-error-report@\texttt{make-error-report}}
  \index{error@\texttt{error}}
\item
  \input{../gen/add-error_function_nst-item-style}
  \index{add-error@\texttt{add-error}}
\item
  \input{../gen/add-failure_function_nst-item-style}
  \index{add-failure@\texttt{add-failure}}
\item
  \input{../gen/add-info_function_nst-item-style}
  \index{add-info@\texttt{add-info}}
\end{itemize}

\subsection{Defining criteria over evaluated values}
\label{sec:def-criterion}
\input{../gen/def-criterion_compiler-macro_nst-item-style}%

\subsection{Processing subcriteria on values}
\label{sec:subcriteria-values}
Since the arguments to the criterion itself (as opposed to the tested
forms) are passed unevaluated as for macro arguments, they can contain
\emph{subcriteria} which can be incorporated into the main criterion's
assessment.%
\input{../gen/check-criterion-on-value_function_nst-item-style}%
% \index{check-subcriterion-on-value@\texttt{check-subcriterion-on-value}}

{\ttfamily\begin{tabbing}
\textrm{Syntax: }(check-subcriterion-on-value CRITERION EXPR)
\end{tabbing}}
% The \texttt{continue-check} function converts subcriteria into quoted
% Lisp:
% \begin{verbatim}
%   (continue-check criterion-form values-forms)
% \end{verbatim}
% The \texttt{values-forms} argument should be a quoted Lisp expression
% which, when evaluated, returns a list of values to be assessed by the
% subcriterion.
% 
% In fact, \texttt{def-form-criterion} and \texttt{def-values-criterion}
% expand to method definitions which are used in \texttt{continue-check}.

\subsection{General criteria definitions}
\label{sec:def-criterion-unevaluated}
\input{../gen/def-criterion-unevaluated_compiler-macro_nst-item-style}
% \index{def-criterion-unevaluated@\texttt{def-criterion-unevaluated}}
% {\ttfamily\begin{tabbing}
% \textrm{Syntax: }(de\=f-criterion-unevaluated (\=name
% \\ \>            \>criterion-args-lambda-list)
% \\ \>            \>form-argument)
% \\ \> FORM
% \\ \> FORM
% \\ \> ~$\vdots$
% \\ \> FORM)
% \end{tabbing}}%
% As under \texttt{def-criterion}, the body of these criteria
% definitions receive the forms provided as the actual parameters of the
% criterion itself, and should return a test result report.  However,
% these criteria receive the unevaluated forms under test, deciding when
% and whether to evaluate them.
% % 
% % Examples:
% % \begin{verbatim}
% % (def-form-criterion (:apply (transform criterion) forms)
% %   (continue-check criterion
% % 		  `(multiple-value-list (apply #',transform ,forms))))
% % 
% % (def-form-criterion (:not (subcriterion) exprs-form)
% %   (let ((subcheck (gensym)))
% %     `(let ((,subcheck ,(continue-check subcriterion exprs-form)))
% %        (cond
% %         ((check-result-errors ,subcheck)
% %          ,subcheck)
% %         ((check-result-failures ,subcheck)
% %          (check-result :info (check-result-info ,subcheck)))
% %         (t
% %          (make-failure-report :format "Expected failure from ~s"
% %                        :args '(,subcriterion)))))))
% % \end{verbatim}

\subsection{Processing subcriteria on the unevaluated form}
\label{sec:subcriteria-form}
{\ttfamily\begin{tabbing}
\textrm{Syntax: }(check-subcriterion-on-form CRITERION FORM)
\end{tabbing}}%
\input{../gen/check-criterion-on-form_function_nst-item-style}%
% \index{check-subcriterion-on-form@\texttt{check-subcriterion-on-form}}

%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "manual"
%%% TeX-PDF-mode: t
%%% End: 
